@using Restaurent.Context
@model IEnumerable<Restaurent.Models.MenuProduct>

@{
    ViewData["Title"] = "Our Menu";
    var isAdmin = Context.Session.GetString("IsAdmin") == "True";
    var userId = Context.Session.GetInt32("UserId");

    // تجميع المنتجات حسب الفئة
    var productsByCategory = Model.GroupBy(p => p.Category?.Name ?? "Uncategorized")
                                 .OrderBy(g => g.Key);
    var totalProducts = Model.Count();
}

<div class="container-fluid px-3 px-md-5 mt-4">
    <!-- Active Discounts Banner - Always Visible -->
    <div class="row mb-4">
        <div class="col-12">
            @if (ViewBag.ActiveDiscounts != null && ((List<Restaurent.Models.Discount>)ViewBag.ActiveDiscounts).Any())
            {
                <!-- Discounts Carousel -->
                <div id="discountsCarousel" class="carousel slide bg-gradient shadow-sm rounded" data-bs-ride="carousel" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="carousel-inner py-3">
                        @{
                            var discounts = (List<Restaurent.Models.Discount>)ViewBag.ActiveDiscounts;
                            for (int i = 0; i < discounts.Count; i++)
                            {
                                var discount = discounts[i];
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <div class="container">
                                        <div class="row align-items-center text-white px-3">
                                            <div class="col-md-2 text-center">
                                                <div class="discount-badge-large">
                                                    <i class="fas fa-percentage fa-2x mb-2"></i>
                                                    <h2 class="mb-0 fw-bold">@discount.DiscountPercentage%</h2>
                                                    <small>OFF</small>
                                                </div>
                                            </div>
                                            <div class="col-md-7">
                                                <h4 class="mb-2 fw-bold">
                                                    <i class="fas fa-tag me-2"></i>@discount.Name
                                                </h4>
                                                <p class="mb-2">@discount.Description</p>
                                                <div class="d-flex gap-3 flex-wrap">
                                                    @if (discount.CategoryId != null)
                                                    {
                                                        <span class="badge bg-light text-dark">
                                                            <i class="fas fa-utensils me-1"></i>@discount.Category?.Name
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-check-circle me-1"></i>All Categories
                                                        </span>
                                                    }
                                                    @if (discount.IsAgeBased)
                                                    {
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-users me-1"></i>Ages @discount.MinAge - @discount.MaxAge
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="col-md-3 text-center">
                                                <div class="d-flex flex-column">
                                                    <small class="mb-1 opacity-75">Valid Until</small>
                                                    <h5 class="mb-0 fw-bold">@discount.EndDate.ToString("MMM dd, yyyy")</h5>
                                                    <small class="mt-2 badge bg-warning text-dark">
                                                        <i class="fas fa-clock me-1"></i>Limited Time
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    @if (discounts.Count > 1)
                    {
                        <!-- Carousel Controls -->
                        <button class="carousel-control-prev" type="button" data-bs-target="#discountsCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#discountsCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>

                        <!-- Indicators -->
                        <div class="carousel-indicators">
                            @for (int i = 0; i < discounts.Count; i++)
                            {
                                <button type="button" data-bs-target="#discountsCarousel"
                                        data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")"
                                        aria-current="@(i == 0 ? "true" : "false")"
                                        aria-label="Slide @(i + 1)"></button>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- No Active Discounts - Promotional Banner -->
                <div class="alert alert-dismissible fade show border-0 shadow-sm mb-0"
                     style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
                    <div class="row align-items-center text-white py-2">
                        <div class="col-md-2 text-center">
                            <i class="fas fa-gift fa-3x"></i>
                        </div>
                        <div class="col-md-8">
                            <h4 class="mb-1 fw-bold">
                                <i class="fas fa-sparkles me-2"></i>Special Offers Coming Soon!
                            </h4>
                            <p class="mb-0">Stay tuned for exclusive deals and amazing discounts on your favorite dishes</p>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="badge bg-light text-dark fs-6 px-3 py-2">
                                <i class="fas fa-bell me-1"></i>Get Notified
                            </span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Products by Category -->
    <div id="productsContainer">
        @foreach (var categoryGroup in productsByCategory)
        {
            <div class="category-section mb-5" data-category="@categoryGroup.Key">
                <!-- Category Header -->
                <div class="category-header bg-gradient-primary text-white p-4 rounded-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-utensils me-2"></i>
                            @categoryGroup.Key
                        </h3>
                        <span class="badge bg-light text-dark fs-6">
                            @categoryGroup.Count() Items
                        </span>
                    </div>
                </div>

                <!-- Products Grid -->
                <div class="row g-4 p-4 bg-light rounded-bottom">
                    @foreach (var item in categoryGroup)
                    {
                        <div class="col-12 col-sm-6 col-md-4 col-lg-3 product-item"
                             data-category="@categoryGroup.Key"
                             data-name="@item.Name"
                             data-description="@item.Description"
                             data-price="@item.Price">

                            <div class="card product-card h-100 shadow-sm position-relative">
                                <!-- Discount Badge -->
                                @if (HasDiscount(item))
                                {
                                    <div class="position-absolute top-0 start-0 m-0" style="z-index: 10;">
                                        <div class="discount-badge">
                                            <i class="fas fa-tag"></i> OFFER!
                                        </div>
                                    </div>
                                }

                                <div class="position-relative">
                                    <img src="@Url.Content(item.ImageUrl)" alt="@item.Name"
                                         class="card-img-top product-image"
                                         style="height: 200px; width: 100%; object-fit: cover;"
                                         onerror="this.src='/images/placeholder.png'">

                                    <!-- Favorite Button -->
                                    @if (userId != null)
                                    {
                                        <div class="position-absolute top-0 end-0 m-2">
                                            <button class="favorite-btn @(IsFavorite(item.Id) ? "favorite-active" : "favorite-inactive")"
                                                    onclick="toggleFavorite(@item.Id, this)"
                                                    title="@(IsFavorite(item.Id) ? "Remove from favorites" : "Add to favorites")">
                                                <i class="fas fa-heart"></i>
                                            </button>
                                        </div>
                                    }

                                    <!-- Price Badge -->
                                    <div class="position-absolute bottom-0 start-0 m-2">
                                        <span class="badge bg-success fs-6">@item.Price EGP</span>
                                    </div>

                                    <!-- Low Stock Badge -->
                                    @if (item.Quantity < 10 && item.Quantity > 0)
                                    {
                                        <div class="position-absolute bottom-0 end-0 m-2">
                                            <span class="badge bg-danger">Low Stock</span>
                                        </div>
                                    }
                                </div>

                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">@item.Name</h5>
                                    <p class="card-text text-muted flex-grow-1">
                                        @(item.Description?.Length > 80 ? item.Description.Substring(0, 80) + "..." : item.Description)
                                    </p>

                                    <div class="mt-auto">
                                        <!-- Product Info -->
                                        <div class="row text-center small text-muted mb-3">
                                            <div class="col-4">
                                                <i class="fas fa-clock"></i><br>
                                                @item.MinTime-@item.MaxTime min
                                            </div>
                                            <div class="col-4">
                                                <i class="fas fa-box"></i><br>
                                                @item.Quantity left
                                            </div>
                                            <div class="col-4">
                                                <i class="fas fa-fire"></i><br>
                                                @item.DayStock/day
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="d-grid gap-2">
                                            @if (item.Quantity > 0)
                                            {
                                                <button class="btn btn-success btn-sm"
                                                        onclick="addToCart(@item.Id)">
                                                    <i class="fas fa-cart-plus"></i> Add to Cart
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-secondary btn-sm" disabled>
                                                    <i class="fas fa-times"></i> Out of Stock
                                                </button>
                                            }

                                            <a asp-action="Showprd" asp-route-id="@item.Id"
                                               class="btn btn-info btn-sm">
                                                <i class="fas fa-eye"></i> Details
                                            </a>

                                            @if (isAdmin)
                                            {
                                                <div class="btn-group w-100" role="group">
                                                    <a asp-action="Edit" asp-route-id="@item.Id"
                                                       class="btn btn-warning btn-sm">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <a asp-action="Delete" asp-route-id="@item.Id"
                                                       class="btn btn-danger btn-sm">
                                                        <i class="fas fa-trash"></i>
                                                    </a>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="text-center d-none mt-5">
        <div class="alert alert-warning py-5">
            <i class="fas fa-search fa-3x mb-3 text-warning"></i>
            <h3>No products found</h3>
            <p class="mb-0">Try adjusting your search criteria or browse different categories</p>
        </div>
    </div>

    <!-- Call to Action Section -->
    <div class="row mt-5 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);">
                <div class="card-body text-center text-white py-4">
                    <h3 class="mb-3">
                        <i class="fas fa-star me-2"></i>
                        Hungry for More Deals?
                        <i class="fas fa-star ms-2"></i>
                    </h3>
                    <p class="lead mb-3">
                        @if (HasActiveDiscounts())
                        {
                            <text>Don't miss out on our exclusive offers! Order now and save big!</text>
                        }
                        else
                        {
                            <text>Subscribe to our newsletter for exclusive deals and early access to promotions!</text>
                        }
                    </p>
                    <div class="d-flex gap-3 justify-content-center flex-wrap">
                        <a asp-controller="MenuProduct" asp-action="GetAll" class="btn btn-light btn-lg">
                            <i class="fas fa-utensils me-2"></i>Browse Menu
                        </a>
                        @if (Context.Session.GetInt32("UserId") == null)
                        {
                            <a asp-controller="User" asp-action="Register" class="btn btn-outline-light btn-lg">
                                <i class="fas fa-user-plus me-2"></i>Join Now
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        /* Discount Carousel Styles */
        #discountsCarousel {
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .discount-badge-large {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

            .discount-badge-large i {
                opacity: 0.9;
            }

        /* Product Discount Badge */
        .discount-badge {
            background: linear-gradient(135deg, #f12711 0%, #f5af19 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 0 0 10px 0;
            font-weight: bold;
            font-size: 0.75rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        /* Carousel Controls */
        .carousel-control-prev,
        .carousel-control-next {
            width: 5%;
            opacity: 0.8;
        }

            .carousel-control-prev:hover,
            .carousel-control-next:hover {
                opacity: 1;
            }

        /* Carousel Indicators */
        .carousel-indicators {
            bottom: -35px;
        }

            .carousel-indicators button {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background-color: #667eea;
            }

        /* Favorite Button Styles */
        .favorite-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Favorite Button - Inactive State (Gray) */
        .favorite-inactive i {
            color: #6c757d !important; /* Gray color */
            transition: color 0.3s ease;
        }

        .favorite-inactive:hover i {
            color: #dc3545 !important; /* Red color on hover */
        }

        /* Favorite Button - Active State (Red) */
        .favorite-active i {
            color: #dc3545 !important; /* Red color */
            animation: heartBeat 0.3s ease;
        }

        .favorite-btn:hover {
            transform: scale(1.1);
            background: white;
        }

        @@keyframes heartBeat {
            0%, 100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.3);
            }
        }

        /* Product Card Hover Effect */
        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
            }

        /* Animation for badges */
        .badge {
            animation: fadeInUp 0.5s ease-in-out;
        }

        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Promotional Banner Styles */
        .alert-dismissible .btn-close-white {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }

            .alert-dismissible .btn-close-white:hover {
                opacity: 1;
            }

        /* Category Header */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Responsive adjustments */
        @@media (max-width: 768px) {
            .discount-badge-large {
                margin-bottom: 15px;
            }

            #discountsCarousel .row {
                text-align: center;
            }

            .carousel-indicators {
                bottom: -25px;
            }

            .discount-badge {
                font-size: 0.65rem;
                padding: 3px 10px;
            }
        }
    </style>

    <script>
        // Auto-slide carousel every 5 seconds
        $(document).ready(function() {
            // Initialize carousel if it exists
            if ($('#discountsCarousel').length) {
                var carousel = new bootstrap.Carousel(document.getElementById('discountsCarousel'), {
                    interval: 5000,
                    wrap: true,
                    pause: 'hover'
                });
            }

            // Check favorite status for all products
            $('.favorite-btn').each(function() {
                var productId = $(this).attr('onclick').match(/\d+/)[0];
                checkFavoriteStatus(productId, $(this));
            });
        });

        // Check if product is in favorites
        function checkFavoriteStatus(productId, button) {
            $.get('@Url.Action("IsFavorite", "Favorite")', { productId: productId }, function(data) {
                if (data.isFavorite) {
                    $(button).removeClass('favorite-inactive').addClass('favorite-active');
                } else {
                    $(button).removeClass('favorite-active').addClass('favorite-inactive');
                }
            });
        }

        // Toggle favorite
        function toggleFavorite(productId, button) {
            $.ajax({
                url: '@Url.Action("ToggleFavorite", "Favorite")',
                type: 'POST',
                data: { productId: productId },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        if (response.isFavorite) {
                            $(button).removeClass('favorite-inactive').addClass('favorite-active');
                        } else {
                            $(button).removeClass('favorite-active').addClass('favorite-inactive');
                        }

                        // Show toast notification
                        showToast(response.message, 'success');
                    } else {
                        showToast(response.message, 'error');
                    }
                },
                error: function() {
                    showToast('An error occurred. Please try again.', 'error');
                }
            });
        }

        // Add to cart function
        function addToCart(productId) {
            $.ajax({
                url: '@Url.Action("AddToCart", "Cart")',
                type: 'POST',
                data: { productId: productId, quantity: 1 },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        showToast(response.message, 'success');
                        updateCartCount();
                    } else {
                        showToast(response.message, 'error');
                    }
                },
                error: function() {
                    showToast('An error occurred. Please try again.', 'error');
                }
            });
        }

        // Update cart count
        function updateCartCount() {
            $.get('@Url.Action("GetCartCount", "Cart")', function(data) {
                if (data.count !== undefined) {
                    $('#cartCount').text(data.count);
                }
            });
        }

        // Show toast notification
        function showToast(message, type) {
            const bgColor = type === 'success' ? '#28a745' : '#dc3545';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

            const toast = `
                <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999;">
                    <div class="toast show" role="alert">
                        <div class="toast-body" style="background-color: ${bgColor}; color: white;">
                            <i class="fas ${icon} me-2"></i>${message}
                        </div>
                    </div>
                </div>
            `;

            $('body').append(toast);
            setTimeout(function() {
                $('.toast').fadeOut(function() { $(this).parent().remove(); });
            }, 3000);
        }
    </script>
}

@functions {
    // Check if product is in user's favorites
    public bool IsFavorite(int productId)
    {
        var userId = Context.Session.GetInt32("UserId");
        if (userId == null) return false;

        using var context = new AppDpContext();
        return context.Favorites.Any(f => f.UserId == userId && f.MenuProductId == productId);
    }

    // Check if product has active discount
    public bool HasDiscount(MenuProduct product)
    {
        using var context = new AppDpContext();
        var now = DateTime.UtcNow;
        return context.Discounts.Any(d =>
            d.IsActive &&
            d.StartDate <= now &&
            d.EndDate >= now &&
            (d.CategoryId == null || d.CategoryId == product.CategoryId)
        );
    }

    // Check if there are any active discounts
    public bool HasActiveDiscounts()
    {
        using var context = new AppDpContext();
        var now = DateTime.UtcNow;
        return context.Discounts.Any(d => d.IsActive && d.StartDate <= now && d.EndDate >= now);
    }
}